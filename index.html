<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto GEM RASA</title>
    <link rel="icon" type="image/png" href="/icon.png">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: url('/background.jpg') no-repeat center center fixed, linear-gradient(135deg, #1e1e2f, #3b3b5e);
            background-size: cover;
            color: #fff;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .icon-wrapper {
            text-align: center;
            margin-bottom: 30px;
        }
        .icon {
            width: 120px;
            height: 120px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7));
            transition: transform 0.3s;
        }
        .icon:hover {
            transform: scale(1.1);
        }
        h1 {
            font-size: 2.5rem;
            text-align: center;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin: 10px 0;
        }
        h3 {
            font-size: 1.5rem;
            color: #00eaff;
            margin: 20px 0 10px;
        }
        select, input, button {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: 10px auto;
            border-radius: 10px;
            font-size: 1.1rem;
            display: block;
            box-sizing: border-box;
        }
        select, input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        button {
            background: linear-gradient(90deg, #00eaff, #007bff);
            border: none;
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.5);
        }
        .market-data, .history, .news {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .market-card, .history-card, .news-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            transition: transform 0.3s;
        }
        .market-card:hover, .history-card:hover, .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        .news-card a {
            color: #00eaff;
            text-decoration: none;
        }
        .news-card a:hover {
            text-decoration: underline;
        }
        #result {
            margin-top: 20px;
            font-size: 1.2rem;
            color: #00ffcc;
            text-align: center;
        }
        .charts {
            margin-top: 30px;
        }
        canvas {
            max-width: 100%;
            height: 400px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon-wrapper">
            <img src="/icon.png" alt="Crypto GEM RASA Icon" class="icon" onerror="this.onerror=null; this.src='https://via.placeholder.com/120?text=Logo+Not+Found';">
        </div>
        <select id="language" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="ru">Русский</option>
        </select>
        <h1 data-lang="title"></h1>
        <p data-lang="welcome"></p>
        <h3 data-lang="convert"></h3>
        <select id="fromCurrency">
            <option value="TON">TON (Toncoin)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="PEPE">PEPE (Pepe Coin)</option>
        </select>
        <input type="number" id="amount" data-lang-placeholder="amount">
        <select id="toCurrency">
            <option value="TON">TON (Toncoin)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="PEPE">PEPE (Pepe Coin)</option>
        </select>
        <button onclick="convertCurrency()" data-lang="convert_btn"></button>
        <p id="result"></p>
        <h3 data-lang="market_data"></h3>
        <div class="market-data" id="marketData"></div>
        <h3 data-lang="history"></h3>
        <div class="history" id="historyData"></div>
        <h3 data-lang="charts"></h3>
        <div class="charts">
            <canvas id="priceChart"></canvas>
        </div>
        <h3 data-lang="news"></h3>
        <div class="news" id="newsData"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const translations = {
            en: {
                title: "Crypto GEM RASA Exchange",
                welcome: "Welcome to your Telegram exchange!",
                convert: "Convert Currency",
                amount: "Enter amount",
                convert_btn: "Convert",
                market_data: "Market Data",
                history: "Transaction History",
                charts: "Price Charts",
                news: "Crypto News",
                play_btn: "Play"
            },
            ru: {
                title: "Биржа Crypto GEM RASA",
                welcome: "Добро пожаловать в вашу биржу в Telegram!",
                convert: "Конвертация валюты",
                amount: "Введите сумму",
                convert_btn: "Конвертировать",
                market_data: "Данные рынка",
                history: "История транзакций",
                charts: "Графики цен",
                news: "Новости криптовалют",
                play_btn: "Играть"
            }
        };

        let currentLang = "en";
        const exchangeRates = {
            "TON": { "SOL": 0.05, "ADA": 10, "BTC": 0.00008, "ETH": 0.002, "BNB": 0.01, "SHIB": 250000, "PEPE": 500000 },
            "SOL": { "TON": 20, "ADA": 200, "BTC": 0.0016, "ETH": 0.04, "BNB": 0.2, "SHIB": 5000000, "PEPE": 10000000 },
            "ADA": { "TON": 0.1, "SOL": 0.005, "BTC": 0.000008, "ETH": 0.0002, "BNB": 0.001, "SHIB": 25000, "PEPE": 50000 },
            "BTC": { "TON": 12500, "SOL": 625, "ADA": 125000, "ETH": 25, "BNB": 125, "SHIB": 3125000000, "PEPE": 6250000000 },
            "ETH": { "TON": 500, "SOL": 25, "ADA": 5000, "BTC": 0.04, "BNB": 5, "SHIB": 125000000, "PEPE": 250000000 },
            "BNB": { "TON": 100, "SOL": 5, "ADA": 1000, "BTC": 0.008, "ETH": 0.2, "SHIB": 25000000, "PEPE": 50000000 },
            "SHIB": { "TON": 0.000004, "SOL": 0.0000002, "ADA": 0.00004, "BTC": 0.00000000032, "ETH": 0.000000008, "BNB": 0.00000004, "PEPE": 2 },
            "PEPE": { "TON": 0.000002, "SOL": 0.0000001, "ADA": 0.00002, "BTC": 0.00000000016, "ETH": 0.000000004, "BNB": 0.00000002, "SHIB": 0.5 }
        };

        const marketData = {
            TON: { price: 0, volume: 0 },
            SOL: { price: 0, volume: 0 },
            ADA: { price: 0, volume: 0 },
            BTC: { price: 0, volume: 0 },
            ETH: { price: 0, volume: 0 },
            BNB: { price: 0, volume: 0 },
            SHIB: { price: 0, volume: 0 },
            PEPE: { price: 0, volume: 0 }
        };

        let liveChartData = {};
        let transactionHistory = [];
        let lastFetchTime = 0;
        let lastNewsFetchTime = 0;
        let latestNews = [];
        const CACHE_DURATION = 60000; // 1 دقیقه کش
        const CHART_UPDATE_INTERVAL = 300000; // 5 دقیقه برای به‌روزرسانی چارت
        const NEWS_CHECK_INTERVAL = 600000; // 10 دقیقه برای چک کردن اخبار

        const coinMapping = {
            "TON": "the-open-network",
            "SOL": "solana",
            "ADA": "cardano",
            "BTC": "bitcoin",
            "ETH": "ethereum",
            "BNB": "binancecoin",
            "SHIB": "shiba-inu",
            "PEPE": "pepe"
        };

        async function fetchMarketData() {
            const now = Date.now();
            if (now - lastFetchTime < CACHE_DURATION) {
                updateMarketData();
                return;
            }

            try {
                const response = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=the-open-network,solana,cardano,bitcoin,ethereum,binancecoin,shiba-inu,pepe&order=market_cap_desc&per_page=100&page=1&sparkline=false");
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error("Too Many Requests. Retrying in 10 seconds...");
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                data.forEach(coin => {
                    const mappedKey = Object.keys(coinMapping).find(key => coinMapping[key] === coin.id);
                    if (mappedKey) {
                        marketData[mappedKey].price = coin.current_price;
                        marketData[mappedKey].volume = coin.total_volume;
                    }
                });
                lastFetchTime = now;
                updateMarketData();
            } catch (error) {
                console.error("Error fetching data from CoinGecko:", error);
                if (error.message.includes("Too Many Requests")) {
                    setTimeout(fetchMarketData, 10000);
                    document.getElementById("marketData").innerHTML = currentLang === "en" ? "Rate limit exceeded. Retrying..." : "Превышен лимит запросов. Повторная попытка...";
                } else {
                    document.getElementById("marketData").innerHTML = currentLang === "en" ? "Error fetching data. Please try again later." : "Ошибка получения данных. Пожалуйста, попробуйте позже.";
                }
            }
        }

        async function fetchChartData() {
            try {
                for (const coin of Object.keys(coinMapping)) {
                    const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinMapping[coin]}/market_chart?vs_currency=usd&days=7`);
                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error("Too Many Requests. Retrying in 10 seconds...");
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    liveChartData[coin] = data.prices.slice(-7).map(price => price[1]);
                }
                updateChart();
            } catch (error) {
                console.error("Error fetching chart data from CoinGecko:", error);
                if (error.message.includes("Too Many Requests")) {
                    setTimeout(fetchChartData, 10000);
                }
            }
        }

        async function fetchNews() {
            const newsContainer = document.getElementById("newsData");
            newsContainer.innerHTML = currentLang === "en" ? "Loading news..." : "Загрузка новостей...";

            try {
                const response = await fetch("https://min-api.cryptocompare.com/data/v2/news/?lang=EN");
                const data = await response.json();

                newsContainer.innerHTML = "";
                data.Data.slice(0, 5).forEach(news => {
                    const card = document.createElement("div");
                    card.className = "news-card";
                    card.innerHTML = `
                        <h4>${news.title}</h4>
                        <p>${news.body.substring(0, 100)}...</p>
                        <p><small>Source: ${news.source}</small></p>
                        <a href="${news.url}" target="_blank">${currentLang === "en" ? "Read more" : "Читать далее"}</a>
                    `;
                    newsContainer.appendChild(card);
                });

                latestNews = data.Data.slice(0, 5);
            } catch (error) {
                console.error("Error fetching news:", error);
                newsContainer.innerHTML = currentLang === "en" ? "Error fetching news. Please try again later." : "Ошибка получения новостей. Пожалуйста, попробуйте позже.";
            }
        }

        async function checkForNewsUpdates() {
            try {
                const response = await fetch("https://min-api.cryptocompare.com/data/v2/news/?lang=EN");
                const data = await response.json();
                const newNews = data.Data.slice(0, 5);

                if (latestNews.length > 0) {
                    const newItems = newNews.filter(newItem => !latestNews.some(oldItem => oldItem.id === newItem.id));
                    if (newItems.length > 0) {
                        newItems.forEach(news => {
                            Telegram.WebApp.showAlert(`${currentLang === "en" ? "New Crypto News!" : "Новая крипто-новость!"}: ${news.title}`);
                        });
                    }
                }

                latestNews = newNews;
                fetchNews();
            } catch (error) {
                console.error("Error checking for news updates:", error);
            }
        }

        function changeLanguage() {
            currentLang = document.getElementById("language").value;
            document.querySelectorAll("[data-lang]").forEach(el => {
                const key = el.getAttribute("data-lang");
                if (el.tagName === "INPUT") {
                    el.placeholder = translations[currentLang][key];
                } else {
                    el.innerText = translations[currentLang][key];
                }
            });
            Telegram.WebApp.MainButton.setText(translations[currentLang].play_btn);
            updateMarketData();
            updateHistory();
            updateChart();
            fetchNews();
        }

        function updateMarketData() {
            const marketContainer = document.getElementById("marketData");
            marketContainer.innerHTML = "";
            const formatData = (coin, price, volume) => {
                if (currentLang === "en") return `${coin}: Price $${price.toFixed(6)}, Volume $${volume.toLocaleString()}`;
                if (currentLang === "ru") return `${coin}: Цена $${price.toFixed(6)}, Объем $${volume.toLocaleString()}`;
            };
            Object.keys(marketData).forEach(coin => {
                const card = document.createElement("div");
                card.className = "market-card";
                card.innerText = formatData(coin, marketData[coin].price, marketData[coin].volume);
                marketContainer.appendChild(card);
            });
        }

        function updateHistory() {
            const historyContainer = document.getElementById("historyData");
            historyContainer.innerHTML = "";
            const formatHistory = (entry) => {
                if (currentLang === "en") return `${entry.amount} ${entry.from} to ${entry.to} = ${entry.result.toFixed(6)}`;
                if (currentLang === "ru") return `${entry.amount} ${entry.from} в ${entry.to} = ${entry.result.toFixed(6)}`;
            };
            transactionHistory.forEach(entry => {
                const card = document.createElement("div");
                card.className = "history-card";
                card.innerText = formatHistory(entry);
                historyContainer.appendChild(card);
            });
        }

        let chartInstance;
        function updateChart() {
            const ctx = document.getElementById("priceChart");
            if (!ctx) {
                console.error("Canvas element with id 'priceChart' not found.");
                return;
            }
            const context = ctx.getContext("2d");
            if (!context) {
                console.error("Failed to get 2D context for canvas.");
                return;
            }

            if (chartInstance) {
                chartInstance.destroy();
            }

            console.log("Rendering chart with live data:", liveChartData);

            chartInstance = new Chart(context, {
                type: "line",
                data: {
                    labels: ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"],
                    datasets: Object.keys(liveChartData).map(coin => ({
                        label: coin,
                        data: liveChartData[coin] || [],
                        borderColor: getRandomColor(),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.1
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: currentLang === "en" ? "Days" : "Дни",
                                color: "#fff"
                            },
                            ticks: { color: "#fff" }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: currentLang === "en" ? "Price (USD)" : "Цена (USD)",
                                color: "#fff"
                            },
                            ticks: { color: "#fff" }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: "#fff" }
                        }
                    }
                }
            });
        }

        function getRandomColor() {
            const letters = "0123456789ABCDEF";
            let color = "#";
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function convertCurrency() {
            const fromCurrency = document.getElementById("fromCurrency").value;
            const toCurrency = document.getElementById("toCurrency").value;
            const amount = parseFloat(document.getElementById("amount").value);
            const resultElement = document.getElementById("result");

            if (!amount || amount <= 0) {
                resultElement.innerText = currentLang === "en" ? "Please enter a valid amount." : "Пожалуйста, введите действительную сумму.";
                return;
            }
            if (fromCurrency === toCurrency) {
                resultElement.innerText = currentLang === "en" ? "Source and target currencies cannot be the same." : "Исходная и целевая валюты не могут совпадать.";
                return;
            }

            const rate = exchangeRates[fromCurrency][toCurrency];
            const convertedAmount = amount * rate;
            resultElement.innerText = `${amount} ${fromCurrency} = ${convertedAmount.toFixed(6)} ${toCurrency}`;
           
            transactionHistory.push({ from: fromCurrency, to: toCurrency, amount, result: convertedAmount });
            updateHistory();
            Telegram.WebApp.sendData(JSON.stringify({ from: fromCurrency, to: toCurrency, amount, result: convertedAmount }));
        }

        window.onload = function() {
            console.log("Mini app loaded");
            Telegram.WebApp.ready();
            Telegram.WebApp.MainButton.setText(translations[currentLang].play_btn);
            Telegram.WebApp.MainButton.show().onClick(() => convertCurrency());
            fetchMarketData();
            fetchNews();
            fetchChartData();
            changeLanguage();

            setInterval(fetchChartData, CHART_UPDATE_INTERVAL);
            setInterval(checkForNewsUpdates, NEWS_CHECK_INTERVAL);
        };
    </script>
</body>
</html>