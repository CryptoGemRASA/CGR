<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto GEM RASA</title>
    <link rel="icon" type="image/png" href="/CGR/icon.png">
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e1e2f, #3b3b5e);
            color: #fff;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .icon-wrapper {
            text-align: center;
            margin-bottom: 30px;
        }
        .icon {
            width: 120px;
            height: 120px;
            display: block;
            margin: 0 auto;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.7));
            transition: transform 0.3s;
        }
        .icon:hover {
            transform: scale(1.1);
        }
        h1 {
            font-size: 2.5rem;
            text-align: center;
            color: #ffd700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            margin: 10px 0;
        }
        h3 {
            font-size: 1.5rem;
            color: #00eaff;
            margin: 20px 0 10px;
        }
        select, input, button {
            width: 100%;
            max-width: 400px;
            padding: 15px;
            margin: 10px auto;
            border-radius: 10px;
            font-size: 1.1rem;
            display: block;
            box-sizing: border-box;
        }
        select, input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
        }
        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        button {
            background: linear-gradient(90deg, #00eaff, #007bff);
            border: none;
            color: #fff;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 234, 255, 0.5);
        }
        .market-data, .history {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .market-card, .history-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
            transition: transform 0.3s;
        }
        .market-card:hover, .history-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }
        #result {
            margin-top: 20px;
            font-size: 1.2rem;
            color: #00ffcc;
            text-align: center;
        }
        .charts {
            margin-top: 30px;
        }
        canvas {
            max-width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon-wrapper">
            <img src="/CGR/icon.png" alt="Crypto GEM RASA Icon" class="icon">
        </div>
        <select id="language" onchange="changeLanguage()">
            <option value="en">English</option>
            <option value="ru">Русский</option>
        </select>
        <h1 data-lang="title"></h1>
        <p data-lang="welcome"></p>
        <h3 data-lang="convert"></h3>
        <select id="fromCurrency">
            <option value="TON">TON (Toncoin)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="PEPE">PEPE (Pepe Coin)</option>
        </select>
        <input type="number" id="amount" data-lang-placeholder="amount">
        <select id="toCurrency">
            <option value="TON">TON (Toncoin)</option>
            <option value="SOL">SOL (Solana)</option>
            <option value="ADA">ADA (Cardano)</option>
            <option value="BTC">BTC (Bitcoin)</option>
            <option value="ETH">ETH (Ethereum)</option>
            <option value="BNB">BNB (Binance Coin)</option>
            <option value="SHIB">SHIB (Shiba Inu)</option>
            <option value="PEPE">PEPE (Pepe Coin)</option>
        </select>
        <button onclick="convertCurrency()" data-lang="convert_btn"></button>
        <p id="result"></p>
        <h3 data-lang="market_data"></h3>
        <div class="market-data" id="marketData"></div>
        <h3 data-lang="history"></h3>
        <div class="history" id="historyData"></div>
        <h3 data-lang="charts"></h3>
        <div class="charts">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const translations = {
            en: {
                title: "Crypto GEM RASA Exchange",
                welcome: "Welcome to your Telegram exchange!",
                convert: "Convert Currency",
                amount: "Enter amount",
                convert_btn: "Convert",
                market_data: "Market Data",
                history: "Transaction History",
                charts: "Price Charts"
            },
            ru: {
                title: "Биржа Crypto GEM RASA",
                welcome: "Добро пожаловать в вашу биржу в Telegram!",
                convert: "Конвертация валюты",
                amount: "Введите сумму",
                convert_btn: "Конвертировать",
                market_data: "Данные рынка",
                history: "История транзакций",
                charts: "Графики цен"
            }
        };

        let currentLang = "en";
        const exchangeRates = {
            "TON": { "SOL": 0.05, "ADA": 10, "BTC": 0.00008, "ETH": 0.002, "BNB": 0.01, "SHIB": 250000, "PEPE": 500000 },
            "SOL": { "TON": 20, "ADA": 200, "BTC": 0.0016, "ETH": 0.04, "BNB": 0.2, "SHIB": 5000000, "PEPE": 10000000 },
            "ADA": { "TON": 0.1, "SOL": 0.005, "BTC": 0.000008, "ETH": 0.0002, "BNB": 0.001, "SHIB": 25000, "PEPE": 50000 },
            "BTC": { "TON": 12500, "SOL": 625, "ADA": 125000, "ETH": 25, "BNB": 125, "SHIB": 3125000000, "PEPE": 6250000000 },
            "ETH": { "TON": 500, "SOL": 25, "ADA": 5000, "BTC": 0.04, "BNB": 5, "SHIB": 125000000, "PEPE": 250000000 },
            "BNB": { "TON": 100, "SOL": 5, "ADA": 1000, "BTC": 0.008, "ETH": 0.2, "SHIB": 25000000, "PEPE": 50000000 },
            "SHIB": { "TON": 0.000004, "SOL": 0.0000002, "ADA": 0.00004, "BTC": 0.00000000032, "ETH": 0.000000008, "BNB": 0.00000004, "PEPE": 2 },
            "PEPE": { "TON": 0.000002, "SOL": 0.0000001, "ADA": 0.00002, "BTC": 0.00000000016, "ETH": 0.000000004, "BNB": 0.00000002, "SHIB": 0.5 }
        };

        const marketData = {
            TON: { price: 0, volume: 0 },
            SOL: { price: 0, volume: 0 },
            ADA: { price: 0, volume: 0 },
            BTC: { price: 0, volume: 0 },
            ETH: { price: 0, volume: 0 },
            BNB: { price: 0, volume: 0 },
            SHIB: { price: 0, volume: 0 },
            PEPE: { price: 0, volume: 0 }
        };

        const chartData = {
            TON: [5.10, 5.15, 5.18, 5.22, 5.19, 5.21, 5.20],
            SOL: [100, 101, 99, 103, 102, 101.5, 102.50],
            ADA: [0.43, 0.44, 0.45, 0.46, 0.44, 0.45, 0.45],
            BTC: [64000, 64500, 65000, 64800, 65200, 65100, 65000],
            ETH: [2550, 2580, 2600, 2590, 2610, 2605, 2600],
            BNB: [510, 515, 520, 518, 522, 521, 520],
            SHIB: [0.000020, 0.000021, 0.0000205, 0.0000212, 0.000021, 0.0000208, 0.000021],
            PEPE: [0.0000095, 0.000010, 0.0000098, 0.0000102, 0.000010, 0.0000099, 0.000010]
        };

        let transactionHistory = [];
        let lastFetchTime = 0;
        const CACHE_DURATION = 60000; // 1 دقیقه کش

        async function fetchMarketData() {
            const now = Date.now();
            if (now - lastFetchTime < CACHE_DURATION) {
                updateMarketData(currentLang);
                return;
            }

            try {
                const response = await fetch("https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=the-open-network,solana,cardano,bitcoin,ethereum,binancecoin,shiba-inu,pepe&order=market_cap_desc&per_page=100&page=1&sparkline=false");
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error("Too Many Requests. Retrying in 10 seconds...");
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                const coinMapping = {
                    "the-open-network": "TON",
                    "solana": "SOL",
                    "cardano": "ADA",
                    "bitcoin": "BTC",
                    "ethereum": "ETH",
                    "binancecoin": "BNB",
                    "shiba-inu": "SHIB",
                    "pepe": "PEPE"
                };

                data.forEach(coin => {
                    const mappedKey = coinMapping[coin.id];
                    if (mappedKey) {
                        marketData[mappedKey].price = coin.current_price;
                        marketData[mappedKey].volume = coin.total_volume;
                    }
                });
                lastFetchTime = now;
                updateMarketData(currentLang);
            } catch (error) {
                console.error("Error fetching data from CoinGecko:", error);
                if (error.message.includes("Too Many Requests")) {
                    setTimeout(fetchMarketData, 10000); // تلاش دوباره بعد از 10 ثانیه
                    document.getElementById("marketData").innerHTML = currentLang === "en" ? "Rate limit exceeded. Retrying..." : "Превышен лимит запросов. Повторная попытка...";
                } else {
                    document.getElementById("marketData").innerHTML = currentLang === "en" ? "Error fetching data. Please try again later." : "Ошибка получения данных. Пожалуйста, попробуйте позже.";
                }
            }
        }

        function changeLanguage() {
            currentLang = document.getElementById("language").value;
            document.querySelectorAll("[data-lang]").forEach(el => {
                const key = el.getAttribute("data-lang");
                if (el.tagName === "INPUT") {
                    el.placeholder = translations[currentLang][key];
                } else {
                    el.innerText = translations[currentLang][key];
                }
            });
            updateMarketData(currentLang);
            updateHistory(currentLang);
            updateChart();
        }

        function updateMarketData() {
            const marketContainer = document.getElementById("marketData");
            marketContainer.innerHTML = "";
            const formatData = (coin, price, volume) => {
                if (currentLang === "en") return `${coin}: Price $${price.toFixed(6)}, Volume $${volume.toLocaleString()}`;
                if (currentLang === "ru") return `${coin}: Цена $${price.toFixed(6)}, Объем $${volume.toLocaleString()}`;
            };
            Object.keys(marketData).forEach(coin => {
                const card = document.createElement("div");
                card.className = "market-card";
                card.innerText = formatData(coin, marketData[coin].price, marketData[coin].volume);
                marketContainer.appendChild(card);
            });
        }

        function updateHistory() {
            const historyContainer = document.getElementById("historyData");
            historyContainer.innerHTML = "";
            const formatHistory = (entry) => {
                if (currentLang === "en") return `${entry.amount} ${entry.from} to ${entry.to} = ${entry.result.toFixed(6)}`;
                if (currentLang === "ru") return `${entry.amount} ${entry.from} в ${entry.to} = ${entry.result.toFixed(6)}`;
            };
            transactionHistory.forEach(entry => {
                const card = document.createElement("div");
                card.className = "history-card";
                card.innerText = formatHistory(entry);
                historyContainer.appendChild(card);
            });
        }

        let chartInstance;
        function updateChart() {
            const ctx = document.getElementById("priceChart").getContext("2d");
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: "line",
                data: {
                    labels: ["Day 1", "Day 2", "Day 3", "Day 4", "Day 5", "Day 6", "Day 7"],
                    datasets: Object.keys(chartData).map(coin => ({
                        label: coin,
                        data: chartData[coin],
                        borderColor: getRandomColor(),
                        fill: false
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        }
        function getRandomColor() {
            const letters = "0123456789ABCDEF";
            let color = "#";
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function convertCurrency() {
            const fromCurrency = document.getElementById("fromCurrency").value;
            const toCurrency = document.getElementById("toCurrency").value;
            const amount = parseFloat(document.getElementById("amount").value);
            const resultElement = document.getElementById("result");

            if (!amount || amount <= 0) {
                resultElement.innerText = currentLang === "en" ? "Please enter a valid amount." : "Пожалуйста, введите действительную сумму.";
                return;
            }
            if (fromCurrency === toCurrency) {
                resultElement.innerText = currentLang === "en" ? "Source and target currencies cannot be the same." : "Исходная и целевая валюты не могут совпадать.";
                return;
            }

            const rate = exchangeRates[fromCurrency][toCurrency];
            const convertedAmount = amount * rate;
            resultElement.innerText = `${amount} ${fromCurrency} = ${convertedAmount.toFixed(6)} ${toCurrency}`;
           
            transactionHistory.push({ from: fromCurrency, to: toCurrency, amount, result: convertedAmount });
            updateHistory();
            Telegram.WebApp.sendData(JSON.stringify({ from: fromCurrency, to: toCurrency, amount, result: convertedAmount }));
        }

        Telegram.WebApp.ready();
        Telegram.WebApp.MainButton.show().onClick(() => convertCurrency());
        fetchMarketData();
        changeLanguage();
    </script>
</body>
</html>